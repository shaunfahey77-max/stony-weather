<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stony's Weather Station | Pro Persistence Build</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --green: #00f5b7;
            --text: #f2f2f2;
            --tile-bg: rgba(18, 22, 38, 0.78); 
            --body-bg: #050a1a;
            --border-color: rgba(255, 255, 255, 0.12);
            --accent-red: #ff4d4d;
            --val-color: #ffffff;
            --label-opacity: 0.6;
            --glass: blur(40px) saturate(180%);
            --mac-shadow: 0 25px 50px rgba(0,0,0,0.6);
            --ease: cubic-bezier(0.23, 1, 0.32, 1);
        }

        body.light-mode {
            --tile-bg: rgba(240, 242, 245, 0.92);
            --text: #1a1a2e;
            --body-bg: #eef2f7;
            --border-color: rgba(0, 0, 0, 0.1);
            --val-color: #000000;
            --label-opacity: 0.85;
            --mac-shadow: 0 15px 40px rgba(0,0,0,0.12);
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        
        body {
            margin: 0; padding: 0;
            font-family: "Poppins", sans-serif;
            background: var(--body-bg);
            /* FIX: Background image path and blending */
            background-image: linear-gradient(rgba(5, 10, 26, 0.6), rgba(5, 10, 26, 0.6)), url('background.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: cover;
            color: var(--text);
            min-height: 100vh;
            transition: background 0.8s var(--ease);
        }

        /* Standard macOS Menu Bar & Tiles from your source */
        .mac-menu-bar { height: 32px; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(20px); display: flex; justify-content: space-between; align-items: center; padding: 0 22px; font-size: 0.82rem; font-weight: 600; position: sticky; top: 0; z-index: 10002; border-bottom: 1px solid rgba(255,255,255,0.1); color: #fff; }
        header { padding: 40px 20px 20px; text-align: center; }
        .title-main { font-size: 5.5rem; font-weight: 900; line-height: 0.8; text-shadow: 7px 7px 0 rgba(0,0,0,0.8); letter-spacing: -3px; color: #fff; }
        .title-sub { font-size: 1.8rem; font-weight: 300; letter-spacing: 12px; text-transform: uppercase; color: var(--green); display: block; margin-top: 15px; }

        .app-shell { max-width: 1700px; margin: 0 auto; padding: 20px 40px 100px; display: grid; grid-template-columns: 1.15fr 0.85fr; gap: 30px; }
        .glass-tile { background: var(--tile-bg); border-radius: 45px; padding: 45px; border: 1px solid var(--border-color); backdrop-filter: var(--glass); box-shadow: var(--mac-shadow); position: relative; display: flex; flex-direction: column; min-height: 720px; }

        /* Current Weather & Grid */
        .current-header-grid { display: grid; grid-template-columns: 100px 1fr 280px; gap: 30px; align-items: center; margin-bottom: 25px; }
        .mascot-cell img { width: 100px; border-radius: 20px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.4)); animation: floating 6s ease-in-out infinite alternate; }
        @keyframes floating { 0% { transform: translateY(0); } 100% { transform: translateY(-15px); } }
        .primary-temp { font-size: 10rem; font-weight: 900; color: var(--green); line-height: 0.8; letter-spacing: -6px; }
        .condition-label { font-weight: 900; color: var(--green); letter-spacing: 4px; text-transform: uppercase; font-size: 1.4rem; }
        .mac-btn { padding: 16px; border-radius: 20px; border: 2px solid var(--green); background: transparent; color: var(--green); font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.3s var(--ease); display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;}
        .mac-btn:hover { background: var(--green); color: #000; transform: translateY(-3px); }

        .sensor-matrix { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 100%; }
        .data-point { background: rgba(255,255,255,0.05); padding: 28px 20px; border-radius: 25px; border: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; text-align: center; }
        .d-label { font-size: 0.8rem; text-transform: uppercase; opacity: var(--label-opacity); font-weight: 600; }
        .d-value { font-weight: 900; font-size: 1.8rem; color: var(--val-color); margin-top: 5px; }

        /* RADAR SYSTEM */
        .radar-panel { grid-column: 1 / -1; height: 550px; padding: 0; overflow: hidden; background: #000; position: relative; margin-top: 10px; }
        #map { width: 100%; height: 100%; z-index: 1; }
        .radar-controls { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; align-items: center; gap: 20px; background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); padding: 12px 25px; border-radius: 50px; border: 1px solid var(--border-color); }
        .radar-btn { background: none; border: none; color: var(--green); cursor: pointer; font-size: 1.4rem; }

        /* Alert Styling */
        .mac-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10001; backdrop-filter: blur(20px); }
        .modal-body { background: var(--tile-bg); width: 85%; max-width: 1000px; margin: 5% auto; padding: 60px; border-radius: 40px; border: 2px solid var(--green); position: relative; max-height: 80vh; overflow-y: auto; color: white; }
        .alert-entry { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; margin-bottom: 20px; }
        .alert-entry h3 { color: var(--accent-red); margin-top: 0; }
        .alert-entry pre { white-space: pre-wrap; font-family: inherit; font-size: 0.9rem; opacity: 0.8; }

        #hazardBtn.active-warn { border-color: var(--accent-red); color: var(--accent-red); animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="dark-mode">

    <div class="mac-menu-bar">
        <div class="menu-left">
            <i class="fa-brands fa-apple"></i>
            <span style="font-weight:900; margin-left: 8px;">StonyWeather</span>
            <input type="text" id="zipInput" class="zip-input" maxlength="5" style="margin-left: 10px;">
        </div>
        <div class="menu-right">
            <span id="systemClock">--:-- --</span>
        </div>
    </div>

    <header>
        <span class="title-main">Stony's</span>
        <span class="title-sub">Weather Station</span>
    </header>

    <main class="app-shell">
        <div class="glass-tile">
            <div class="current-header-grid">
                <div class="mascot-cell"><img src="mascot.png" alt="Mascot"></div>
                <div class="temp-cell">
                    <div class="primary-temp" id="dispTemp">--°</div>
                    <div class="condition-label" id="dispSummary">Syncing...</div>
                </div>
                <div class="btn-stack">
                    <button class="mac-btn" onclick="openModal('modalAFD')"><i class="fa-solid fa-file-waveform"></i> Discussion</button>
                    <button id="hazardBtn" class="mac-btn" onclick="openModal('modalAlerts')"><i class="fa-solid fa-shield-halved"></i> No Hazards</button>
                </div>
            </div>
            <div class="forecast-summary" id="dispDetail">Establishing satellite link...</div>
            <div class="sensor-matrix">
                <div class="data-point"><i class="fa-solid fa-temperature-half"></i><span class="d-label">Feels Like</span><span class="d-value" id="valFeels">--</span></div>
                <div class="data-point"><i class="fa-solid fa-wind"></i><span class="d-label">Wind Gust</span><span class="d-value" id="valWind">--</span></div>
                <div class="data-point"><i class="fa-solid fa-droplet"></i><span class="d-label">Humidity</span><span class="d-value" id="valHum">--</span></div>
                <div class="data-point"><i class="fa-solid fa-eye"></i><span class="d-label">Visibility</span><span class="d-value" id="valVis">--</span></div>
                <div class="data-point"><i class="fa-solid fa-sun"></i><span class="d-label">UV Index</span><span class="d-value" id="valUV">--</span></div>
                <div class="data-point"><i class="fa-solid fa-cloud-rain"></i><span class="d-label">Dew Point</span><span class="d-value" id="valDew">--</span></div>
            </div>
        </div>

        <div class="glass-tile">
            <h3 style="margin-bottom:25px; text-transform:uppercase; letter-spacing:5px; font-size:0.9rem; opacity:0.6;"><i class="fa-solid fa-calendar-days" style="color:var(--green)"></i> 14-Day Outlook</h3>
            <div id="gridForecast" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
        </div>

        <div class="glass-tile radar-panel">
            <div id="map"></div>
            <div class="radar-controls">
                <button class="radar-btn" onclick="toggleRadar()"><i id="playIcon" class="fa-solid fa-play"></i></button>
                <span id="radarTime" style="color: white; font-size: 0.8rem; min-width: 100px; text-align: center;">Live</span>
            </div>
        </div>
    </main>

    <div id="modalAFD" class="mac-modal"><div class="modal-body"><span onclick="closeModal('modalAFD')" style="cursor:pointer; float:right; font-size:2rem;">&times;</span><h2>Forecaster Discussion</h2><pre id="bodyAFD" style="white-space:pre-wrap;"></pre></div></div>
    <div id="modalAlerts" class="mac-modal"><div class="modal-body"><span onclick="closeModal('modalAlerts')" style="cursor:pointer; float:right; font-size:2rem;">&times;</span><h2>Weather Alerts & Outlook</h2><div id="bodyAlerts"></div></div></div>

    <script>
        let map, radarLayers = [], timestamps = [], currentFrame = 0, radarInterval;

        async function initMap(lat, lon) {
            if (!map) {
                map = L.map('map', { zoomControl: false, attributionControl: false }).setView([lat, lon], 9);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            } else {
                map.setView([lat, lon], 9);
            }

            // Fetch RainViewer timestamps for animation
            const rvData = await fetch('https://api.rainviewer.com/public/maps.json').then(r => r.json());
            timestamps = rvData.slice(-12); // Last 2 hours (10 min intervals)
            
            // Clear existing layers
            radarLayers.forEach(l => map.removeLayer(l));
            radarLayers = [];

            // Pre-load layers
            timestamps.forEach((ts, idx) => {
                const layer = L.tileLayer(`https://tilecache.rainviewer.com/v2/radar/${ts}/256/{z}/{x}/{y}/1/1_1.png`, {
                    opacity: 0,
                    zIndex: 100
                });
                radarLayers.push(layer);
                layer.addTo(map);
            });

            // Show latest frame by default
            currentFrame = radarLayers.length - 1;
            radarLayers[currentFrame].setOpacity(0.7);
            updateFrameTime();
        }

        function toggleRadar() {
            const icon = document.getElementById('playIcon');
            if (radarInterval) {
                clearInterval(radarInterval);
                radarInterval = null;
                icon.className = 'fa-solid fa-play';
            } else {
                icon.className = 'fa-solid fa-pause';
                radarInterval = setInterval(() => {
                    radarLayers[currentFrame].setOpacity(0);
                    currentFrame = (currentFrame + 1) % radarLayers.length;
                    radarLayers[currentFrame].setOpacity(0.7);
                    updateFrameTime();
                }, 600);
            }
        }

        function updateFrameTime() {
            const date = new Date(timestamps[currentFrame] * 1000);
            document.getElementById('radarTime').innerText = date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }

        async function refreshStation() {
            const zip = document.getElementById('zipInput').value || "03101";
            localStorage.setItem('stonyZip', zip);

            try {
                const geo = await fetch(`https://api.zippopotam.us/us/${zip}`).then(r => r.json());
                const { latitude: lat, longitude: lon } = geo.places[0];
                
                initMap(lat, lon);

                // Existing weather logic from your source
                const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,uv_index,visibility,dew_point_2m&daily=weather_code,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto&forecast_days=14`).then(r => r.json());
                document.getElementById('dispTemp').innerText = Math.round(w.current.temperature_2m) + "°";
                document.getElementById('valFeels').innerText = Math.round(w.current.apparent_temperature) + "°F";
                document.getElementById('valWind').innerText = Math.round(w.current.wind_speed_10m) + " mph";
                document.getElementById('valHum').innerText = w.current.relative_humidity_2m + "%";
                document.getElementById('valVis').innerText = (w.current.visibility / 1609).toFixed(1) + " mi";
                
                // --- FULL ALERT LOGIC WITH DETAILS ---
                const alertData = await fetch(`https://api.weather.gov/alerts/active?point=${lat},${lon}`).then(r => r.json());
                
                // Fetch Hazardous Weather Outlook separately
                const points = await fetch(`https://api.weather.gov/points/${lat},${lon}`).then(r => r.json());
                const officeId = points.properties.gridId;
                const hwoData = await fetch(`https://api.weather.gov/products/types/HWO/locations/${officeId}`).then(r => r.json());
                
                const hb = document.getElementById('hazardBtn');
                const alertBody = document.getElementById('bodyAlerts');
                alertBody.innerHTML = "";

                let hasHazards = false;

                // Process Active Alerts
                if (alertData.features.length > 0) {
                    hasHazards = true;
                    alertData.features.forEach(feat => {
                        alertBody.innerHTML += `
                            <div class="alert-entry">
                                <h3>${feat.properties.event}</h3>
                                <p><strong>Headline:</strong> ${feat.properties.headline}</p>
                                <pre>${feat.properties.description}</pre>
                                <p><small>Instruction: ${feat.properties.instruction || 'N/A'}</small></p>
                            </div>`;
                    });
                }

                // Process Hazardous Weather Outlook (HWO)
                if (hwoData['@graph'] && hwoData['@graph'].length > 0) {
                    hasHazards = true;
                    const hwoProduct = await fetch(hwoData['@graph'][0]['@id']).then(r => r.json());
                    alertBody.innerHTML += `
                        <div class="alert-entry" style="border-left: 4px solid var(--green); padding-left: 15px;">
                            <h3 style="color: var(--green)">Hazardous Weather Outlook</h3>
                            <pre>${hwoProduct.productText}</pre>
                        </div>`;
                }

                if (hasHazards) {
                    hb.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Hazards Active';
                    hb.classList.add('active-warn');
                } else {
                    hb.innerHTML = '<i class="fa-solid fa-shield-halved"></i> No Hazards';
                    hb.classList.remove('active-warn');
                    alertBody.innerHTML = "<p>No active alerts or hazardous outlooks for this location.</p>";
                }

                // Discussion (AFD)
                const afdList = await fetch(`https://api.weather.gov/products/types/AFD/locations/${officeId}`).then(r => r.json());
                const afd = await fetch(afdList['@graph'][0]['@id']).then(r => r.json());
                document.getElementById('bodyAFD').innerText = afd.productText;

            } catch(e) { console.error("Sync Error:", e); }
        }

        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        document.getElementById('zipInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') refreshStation(); });
        setInterval(() => { document.getElementById('systemClock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }, 1000);
        
        // Initial Boot
        const savedZip = localStorage.getItem('stonyZip') || "03101";
        document.getElementById('zipInput').value = savedZip;
        refreshStation();
    </script>
</body>
</html>
