<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stony's Weather Station | Pro Persistence Build</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --green: #00f5b7;
      --text: #f2f2f2;
      --tile-bg: rgba(18, 22, 38, 0.78);
      --body-bg: #050a1a;
      --border-color: rgba(255, 255, 255, 0.12);
      --accent-red: #ff4d4d;
      --val-color: #ffffff;
      --label-opacity: 0.6;
      --glass: blur(40px) saturate(180%);
      --mac-shadow: 0 25px 50px rgba(0,0,0,0.6);
      --ease: cubic-bezier(0.23, 1, 0.32, 1);

      /* Radar tuning */
      --radar-overlay-opacity: 0.78;
      --radar-contrast: 1.15;
      --radar-saturate: 1.15;
      --radar-brightness: 1.05;
    }

    body.light-mode {
      --tile-bg: rgba(240, 242, 245, 0.92);
      --text: #1a1a2e;
      --body-bg: #eef2f7;
      --border-color: rgba(0, 0, 0, 0.1);
      --val-color: #000000;
      --label-opacity: 0.85;
      --mac-shadow: 0 15px 40px rgba(0,0,0,0.12);

      /* Radar tuning in light mode */
      --radar-overlay-opacity: 0.8;
      --radar-contrast: 1.10;
      --radar-saturate: 1.05;
      --radar-brightness: 1.02;
    }

    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }

    body {
      margin: 0; padding: 0;
      font-family: "Poppins", sans-serif;
      background: var(--body-bg) url('./background.png') no-repeat center center fixed;
      background-size: cover;
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      transition: background 0.8s var(--ease);
    }

    .mac-menu-bar {
      height: 32px;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(20px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 22px;
      font-size: 0.82rem;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10002;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      color: #fff;
      gap: 16px;
    }

    header { padding: 40px 20px 20px; text-align: center; }
    .title-main {
      font-size: 5.5rem;
      font-weight: 900;
      line-height: 0.8;
      text-shadow: 7px 7px 0 rgba(0,0,0,0.8);
      letter-spacing: -3px;
      color: #fff;
    }
    .title-sub {
      font-size: 1.8rem;
      font-weight: 300;
      letter-spacing: 12px;
      text-transform: uppercase;
      color: var(--green);
      display: block;
      margin-top: 15px;
    }

    .app-shell {
      max-width: 1700px;
      margin: 0 auto;
      padding: 20px 40px 100px;
      display: grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: 30px;
    }

    .glass-tile {
      background: var(--tile-bg);
      border-radius: 45px;
      padding: 45px;
      border: 1px solid var(--border-color);
      backdrop-filter: var(--glass);
      box-shadow: var(--mac-shadow);
      position: relative;
      display: flex;
      flex-direction: column;
      min-height: 720px;
    }

    .current-header-grid {
      display: grid;
      grid-template-columns: 100px 1fr 280px;
      gap: 30px;
      align-items: center;
      margin-bottom: 25px;
    }

    .mascot-cell img {
      width: 100px;
      border-radius: 20px;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,0.4));
      animation: floating 6s ease-in-out infinite alternate;
    }
    @keyframes floating { 0% { transform: translateY(0); } 100% { transform: translateY(-15px); } }

    .primary-temp {
      font-size: 10rem;
      font-weight: 900;
      color: var(--green);
      line-height: 0.8;
      letter-spacing: -6px;
    }
    .condition-label {
      font-weight: 900;
      color: var(--green);
      letter-spacing: 4px;
      text-transform: uppercase;
      font-size: 1.4rem;
    }

    .mac-btn {
      padding: 16px;
      border-radius: 20px;
      border: 2px solid var(--green);
      background: transparent;
      color: var(--green);
      font-weight: 900;
      text-transform: uppercase;
      cursor: pointer;
      transition: 0.3s var(--ease);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .mac-btn:hover { background: var(--green); color: #000; transform: translateY(-3px); }

    .forecast-summary { margin-bottom: 20px; line-height: 1.6; opacity: 0.8; font-size: 0.95rem; }

    .sensor-matrix {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      width: 100%;
    }

    .data-point {
      background: rgba(255,255,255,0.05);
      padding: 28px 20px;
      border-radius: 25px;
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .data-point i { color: var(--green); font-size: 1.6rem; margin-bottom: 12px; }
    .d-label { font-size: 0.8rem; text-transform: uppercase; opacity: var(--label-opacity); font-weight: 600; }
    .d-value { font-weight: 900; font-size: 1.8rem; color: var(--val-color); margin-top: 5px; }

    .forecast-grid-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: repeat(7, 1fr);
      gap: 15px;
      flex-grow: 1;
    }

    .day-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border-color);
      border-radius: 25px;
      padding: 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .day-icon { font-size: 2.2rem; }
    .hi-t { font-weight: 900; font-size: 1.3rem; color: var(--val-color); }
    .lo-t { opacity: 0.5; font-size: 0.9rem; margin-left: 5px; }

    /* Radar Panel */
    .radar-panel {
      grid-column: 1 / -1;
      height: 550px;
      padding: 0;
      overflow: hidden;
      background: #000;
      position: relative;
      min-height: unset;
    }

    #map { width: 100%; height: 100%; z-index: 1; }

    /* Readability overlay */
    .radar-panel::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 2;
      background:
        radial-gradient(1200px 700px at 50% 50%, rgba(0,0,0,0.15), rgba(0,0,0,0.45)),
        linear-gradient(to bottom, rgba(0,0,0,0.15), rgba(0,0,0,0.20));
      mix-blend-mode: multiply;
    }

    /* Filters applied to tiles */
    .radar-panel .leaflet-tile {
      filter: contrast(var(--radar-contrast)) saturate(var(--radar-saturate)) brightness(var(--radar-brightness));
    }

    /* Map Boost state */
    .radar-panel.boost-on .leaflet-tile{
      filter: contrast(1.35) saturate(1.25) brightness(1.12) !important;
    }
    .radar-panel.boost-on::before{
      background:
        radial-gradient(1200px 700px at 50% 50%, rgba(0,0,0,0.10), rgba(0,0,0,0.55)),
        linear-gradient(to bottom, rgba(0,0,0,0.15), rgba(0,0,0,0.28));
    }

    .radar-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
      padding: 8px 15px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
    }

    .radar-btn {
      background: none;
      border: none;
      color: var(--green);
      cursor: pointer;
      font-size: 1.2rem;
    }
    .radar-btn:active { transform: translateY(1px); }

    #boostBtn.is-on{
      background: rgba(0,245,183,0.18);
      border-radius: 14px;
      box-shadow: 0 0 0 1px rgba(0,245,183,0.35) inset;
    }
    #boostBtn.is-on i { color: #fff; }

    .system-dock {
      position: fixed;
      bottom: 30px;
      right: 40px;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(25px);
      padding: 10px 20px;
      border-radius: 25px;
      border: 1px solid rgba(255,255,255,0.1);
      display: flex;
      gap: 15px;
      z-index: 10000;
    }
    .dock-item {
      width: 45px; height: 45px;
      border-radius: 12px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .mac-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 10001;
      backdrop-filter: blur(20px);
    }

    .modal-body {
      background: var(--tile-bg);
      width: 85%;
      max-width: 1000px;
      margin: 5% auto;
      padding: 60px;
      border-radius: 40px;
      border: 2px solid var(--green);
      position: relative;
      max-height: 80vh;
      overflow-y: auto;
    }

    .close-x {
      position: absolute;
      top: 30px; right: 40px;
      font-size: 3rem;
      color: var(--green);
      cursor: pointer;
    }

    .zip-input {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #fff;
      padding: 2px 10px;
      border-radius: 5px;
      font-size: 0.8rem;
      width: 74px;
      text-align: center;
      outline: none;
    }

    #hazardBtn.active-warn {
      border-color: var(--accent-red);
      color: var(--accent-red);
      animation: pulse-red 2s infinite;
    }
    @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    footer {
      text-align: center;
      padding: 40px;
      opacity: 0.4;
      font-size: 0.8rem;
      letter-spacing: 5px;
      text-transform: uppercase;
      width: 100%;
      color: var(--text);
    }

    /* Leaflet container safety */
    .leaflet-container { background: #000; }
    .leaflet-tile { image-rendering: auto; }

    /* =========================
       RESPONSIVE: Tablet
       ========================= */
    @media (max-width: 1200px) {
      .app-shell {
        grid-template-columns: 1fr;
        padding: 16px 22px 90px;
        gap: 22px;
      }
      .glass-tile {
        min-height: unset;
        padding: 34px;
        border-radius: 36px;
      }
      .current-header-grid {
        grid-template-columns: 90px 1fr;
        grid-template-areas:
          "mascot temp"
          "buttons buttons";
        gap: 18px;
      }
      .mascot-cell { grid-area: mascot; }
      .temp-cell { grid-area: temp; }
      .btn-stack { grid-area: buttons; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .mac-btn { margin-bottom: 0; }
      .primary-temp { font-size: 8.2rem; letter-spacing: -5px; }
      .title-main { font-size: 4.6rem; }
      .title-sub { font-size: 1.4rem; letter-spacing: 10px; }
      .sensor-matrix { grid-template-columns: repeat(3, 1fr); }
      .radar-panel { height: 480px; }
      .system-dock { right: 22px; bottom: 22px; }
    }

    /* =========================
       RESPONSIVE: Mobile
       ========================= */
    @media (max-width: 680px) {
      header { padding: 26px 16px 10px; }
      .title-main { font-size: 3.4rem; letter-spacing: -2px; line-height: 0.9; }
      .title-sub { font-size: 1.05rem; letter-spacing: 7px; margin-top: 10px; }

      .mac-menu-bar { padding: 0 12px; font-size: 0.75rem; }
      .menu-left span:last-child { display: none; }

      .app-shell { padding: 12px 14px 95px; gap: 16px; }
      .glass-tile { padding: 22px; border-radius: 28px; }

      .current-header-grid { grid-template-columns: 72px 1fr; gap: 14px; margin-bottom: 18px; }
      .mascot-cell img { width: 72px; border-radius: 16px; }
      .primary-temp { font-size: 5.8rem; letter-spacing: -4px; }
      .condition-label { font-size: 1.05rem; letter-spacing: 2px; }

      .btn-stack { grid-template-columns: 1fr; }

      .sensor-matrix { grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .data-point { padding: 18px 14px; border-radius: 18px; }
      .d-value { font-size: 1.4rem; }

      .forecast-grid-container { grid-template-columns: 1fr; grid-template-rows: none; }
      .day-card { padding: 14px; border-radius: 18px; }
      .day-icon { font-size: 1.9rem; }

      .radar-panel { height: 420px; border-radius: 28px; }
      .radar-controls { bottom: 14px; padding: 8px 12px; gap: 12px; }

      .system-dock {
        left: 50%;
        transform: translateX(-50%);
        right: auto;
        bottom: 14px;
        padding: 10px 14px;
        border-radius: 20px;
      }
      .dock-item { width: 44px; height: 44px; border-radius: 12px; }

      footer { padding: 28px 16px; letter-spacing: 3px; font-size: 0.7rem; }
    }
  </style>
</head>

<body class="dark-mode">

  <audio id="sndClick" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

  <div class="mac-menu-bar">
    <div class="menu-left">
      <i class="fa-brands fa-apple"></i>
      <span style="font-weight:900; margin-left: 8px;">StonyWeather</span>
      <input type="text" id="zipInput" class="zip-input" maxlength="5" style="margin-left: 10px;">
      <span style="opacity: 0.6; margin-left:10px;">File Edit View Station Window Help</span>
    </div>
    <div class="menu-right">
      <i class="fa-solid fa-tower-broadcast"></i>
      <i class="fa-solid fa-wifi" style="margin: 0 10px;"></i>
      <span id="systemClock">--:-- --</span>
    </div>
  </div>

  <header>
    <div class="title-block">
      <span class="title-main">Stony's</span>
      <span class="title-sub">Weather Station</span>
    </div>
  </header>

  <main class="app-shell">
    <div class="glass-tile">
      <div class="current-header-grid">
        <div class="mascot-cell"><img src="mascot.png" alt="Mascot"></div>
        <div class="temp-cell">
          <div class="primary-temp" id="dispTemp">--¬∞</div>
          <div class="condition-label" id="dispSummary">Syncing...</div>
        </div>
        <div class="btn-stack">
          <button class="mac-btn" onclick="openModal('modalAFD')"><i class="fa-solid fa-file-waveform"></i> Discussion</button>
          <button id="hazardBtn" class="mac-btn" onclick="openModal('modalAlerts')"><i class="fa-solid fa-shield-halved"></i> No Hazards</button>
        </div>
      </div>

      <div class="forecast-summary" id="dispDetail">Establishing satellite link...</div>

      <div class="sensor-matrix">
        <div class="data-point"><i class="fa-solid fa-temperature-half"></i><span class="d-label">Feels Like</span><span class="d-value" id="valFeels">--</span></div>
        <div class="data-point"><i class="fa-solid fa-wind"></i><span class="d-label">Wind Gust</span><span class="d-value" id="valWind">--</span></div>
        <div class="data-point"><i class="fa-solid fa-droplet"></i><span class="d-label">Humidity</span><span class="d-value" id="valHum">--</span></div>
        <div class="data-point"><i class="fa-solid fa-eye"></i><span class="d-label">Visibility</span><span class="d-value" id="valVis">--</span></div>
        <div class="data-point"><i class="fa-solid fa-sun"></i><span class="d-label">UV Index</span><span class="d-value" id="valUV">--</span></div>
        <div class="data-point"><i class="fa-solid fa-cloud-rain"></i><span class="d-label">Dew Point</span><span class="d-value" id="valDew">--</span></div>
      </div>
    </div>

    <div class="glass-tile">
      <h3 style="margin-bottom:25px; text-transform:uppercase; letter-spacing:5px; font-size:0.9rem; opacity:0.6;">
        <i class="fa-solid fa-calendar-days" style="color:var(--green)"></i> 14-Day Outlook
      </h3>
      <div id="gridForecast" class="forecast-grid-container"></div>
    </div>

    <div class="glass-tile radar-panel">
      <div id="map"></div>

      <div class="radar-controls">
        <button class="radar-btn" onclick="toggleRadar()"><i id="playIcon" class="fa-solid fa-play"></i></button>

        <!-- Map Boost -->
        <button class="radar-btn" id="boostBtn" onclick="toggleMapBoost()" title="Map Boost">
          <i id="boostIcon" class="fa-solid fa-wand-magic-sparkles"></i>
        </button>

        <span id="radarTime" style="color: white; font-size: 0.7rem; min-width: 60px; text-align: center;">Live</span>
      </div>
    </div>
  </main>

  <div class="system-dock">
    <div class="dock-item" onclick="toggleTheme()"><i class="fa-solid fa-sun"></i></div>
    <div class="dock-item" onclick="toggleAudio()"><i id="volIcon" class="fa-solid fa-volume-xmark"></i></div>
    <div class="dock-item" onclick="refreshStation()"><i class="fa-solid fa-rotate-right"></i></div>
  </div>

  <div id="modalAFD" class="mac-modal">
    <div class="modal-body">
      <span class="close-x" onclick="closeModal('modalAFD')">&times;</span>
      <h2 style="color:var(--green)">Forecaster Discussion</h2>
      <pre id="bodyAFD" style="white-space:pre-wrap; font-family:monospace; color: var(--text);"></pre>
    </div>
  </div>

  <div id="modalAlerts" class="mac-modal">
    <div class="modal-body">
      <span class="close-x" onclick="closeModal('modalAlerts')">&times;</span>
      <h2 id="alertTitle" style="color:var(--accent-red)">Weather Advisories</h2>
      <div id="bodyAlerts" style="color: var(--text);">Scanning...</div>
    </div>
  </div>

  <footer>Manchester Station NH-01 | Latency: <span id="ping">--</span>ms | Last Sync: <span id="syncStamp">--</span></footer>

  <script>
    let audioOn = false;
    let map, radarLayers = [], timestamps = [], currentFrame = 0, radarInterval;
    let mapBoostOn = false;

    function toggleTheme() {
      document.body.classList.toggle('light-mode');
      const isLight = document.body.classList.contains('light-mode');
      localStorage.setItem('stonyTheme', isLight ? 'light' : 'dark');

      if (map) setTimeout(() => map.invalidateSize(true), 150);
    }

    function loadSavedState() {
      const savedTheme = localStorage.getItem('stonyTheme');
      if (savedTheme === 'light') document.body.classList.add('light-mode');

      const savedZip = localStorage.getItem('stonyZip');
      document.getElementById('zipInput').value = savedZip || "03101";
    }

    function loadBoostState(){
      const saved = localStorage.getItem('stonyMapBoost');
      mapBoostOn = saved === '1';
      applyBoostUI();
    }

    function toggleMapBoost(){
      mapBoostOn = !mapBoostOn;
      localStorage.setItem('stonyMapBoost', mapBoostOn ? '1' : '0');
      applyBoostUI();
    }

    function applyBoostUI(){
      const panel = document.querySelector('.radar-panel');
      const btn = document.getElementById('boostBtn');

      if(panel) panel.classList.toggle('boost-on', mapBoostOn);
      if(btn) btn.classList.toggle('is-on', mapBoostOn);

      if(map) setTimeout(() => map.invalidateSize(true), 50);
    }

    async function initRadar(lat, lon) {
      if (!map) {
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView([lat, lon], 9);

        // Base map
        const base = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          opacity: 1,
          zIndex: 10
        }).addTo(map);

        // Labels overlay for readability
        const labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
          opacity: 0.95,
          zIndex: 90
        }).addTo(map);

        map._stonyBase = base;
        map._stonyLabels = labels;
      } else {
        map.setView([lat, lon], 9);
      }

      const rvData = await fetch('https://api.rainviewer.com/public/maps.json').then(r => r.json());
      timestamps = rvData.slice(-12);

      radarLayers.forEach(l => map.removeLayer(l));
      radarLayers = [];

      timestamps.forEach((ts) => {
        const layer = L.tileLayer(`https://tilecache.rainviewer.com/v2/radar/${ts}/256/{z}/{x}/{y}/1/1_1.png`, {
          opacity: 0,
          zIndex: 100
        });
        radarLayers.push(layer);
        layer.addTo(map);
      });

      currentFrame = radarLayers.length - 1;

      const op = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--radar-overlay-opacity')) || 0.78;
      radarLayers[currentFrame].setOpacity(op);

      updateFrameTime();

      // Ensure correct sizing after responsive changes
      setTimeout(() => map.invalidateSize(true), 100);

      // Apply boost class (in case it was saved)
      applyBoostUI();
    }

    function toggleRadar() {
      const icon = document.getElementById('playIcon');
      if (radarInterval) {
        clearInterval(radarInterval);
        radarInterval = null;
        icon.className = 'fa-solid fa-play';
      } else {
        icon.className = 'fa-solid fa-pause';
        radarInterval = setInterval(() => {
          if (!radarLayers.length) return;

          radarLayers[currentFrame].setOpacity(0);
          currentFrame = (currentFrame + 1) % radarLayers.length;

          const op = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--radar-overlay-opacity')) || 0.78;
          radarLayers[currentFrame].setOpacity(op);

          updateFrameTime();
        }, 600);
      }
    }

    function updateFrameTime() {
      const date = new Date(timestamps[currentFrame] * 1000);
      document.getElementById('radarTime').innerText = date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }

    async function refreshStation() {
      const start = Date.now();
      const currentZip = document.getElementById('zipInput').value || "03101";
      localStorage.setItem('stonyZip', currentZip);

      if (audioOn) document.getElementById('sndClick').play();

      try {
        const geo = await fetch(`https://api.zippopotam.us/us/${currentZip}`).then(r => r.json());
        const { latitude: lat, longitude: lon } = geo.places[0];

        initRadar(lat, lon);

        const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,uv_index,visibility,dew_point_2m&daily=weather_code,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto&forecast_days=14`).then(r => r.json());

        document.getElementById('dispTemp').innerText = Math.round(w.current.temperature_2m) + "¬∞";
        document.getElementById('valFeels').innerText = Math.round(w.current.apparent_temperature) + "¬∞F";
        document.getElementById('valWind').innerText = Math.round(w.current.wind_speed_10m) + " mph";
        document.getElementById('valHum').innerText = w.current.relative_humidity_2m + "%";
        document.getElementById('valVis').innerText = (w.current.visibility / 1609).toFixed(1) + " mi";
        document.getElementById('valUV').innerText = w.current.uv_index;
        document.getElementById('valDew').innerText = Math.round(w.current.dew_point_2m) + "¬∞";

        const grid = document.getElementById('gridForecast');
        grid.innerHTML = "";
        w.daily.time.forEach((t, i) => {
          grid.innerHTML += `
            <div class="day-card">
              <span class="day-label">${new Date(t + 'T00:00').toLocaleDateString('en-US', {weekday:'short', month:'numeric', day:'numeric'})}</span>
              <span class="day-icon">${getIcon(w.daily.weather_code[i])}</span>
              <div class="day-temps">
                <span class="hi-t">${Math.round(w.daily.temperature_2m_max[i])}¬∞</span>
                <span class="lo-t">${Math.round(w.daily.temperature_2m_min[i])}¬∞</span>
              </div>
            </div>`;
        });

        const p = await fetch(`https://api.weather.gov/points/${lat},${lon}`).then(r => r.json());
        const f = await fetch(p.properties.forecast).then(r => r.json());
        document.getElementById('dispDetail').innerText = f.properties.periods[0].detailedForecast;
        document.getElementById('dispSummary').innerText = f.properties.periods[0].shortForecast;

        // Enhanced Alerts Logic
        const a = await fetch(`https://api.weather.gov/alerts/active?point=${lat},${lon}`).then(r => r.json());
        const hb = document.getElementById('hazardBtn');
        const alertBody = document.getElementById('bodyAlerts');

        // Fetch HWO
        const officeId = p.properties.gridId;
        const hwoData = await fetch(`https://api.weather.gov/products/types/HWO/locations/${officeId}`).then(r => r.json());

        alertBody.innerHTML = "";
        let hazardFound = false;

        if (a.features.length > 0) {
          hazardFound = true;
          hb.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Hazards Active';
          hb.classList.add('active-warn');
          alertBody.innerHTML = a.features.map(x => `
            <div style="margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
              <h3 style="color: var(--accent-red)">${x.properties.event}</h3>
              <p><strong>Headline:</strong> ${x.properties.headline}</p>
              <pre style="white-space: pre-wrap; font-family: inherit; font-size: 0.85rem; opacity: 0.8;">${x.properties.description}</pre>
            </div>`).join('');
        }

        if (hwoData['@graph'] && hwoData['@graph'].length > 0) {
          hazardFound = true;
          const hwoProduct = await fetch(hwoData['@graph'][0]['@id']).then(r => r.json());
          alertBody.innerHTML += `
            <div style="margin-top: 20px; padding: 15px; background: rgba(0, 245, 183, 0.05); border-radius: 15px; border-left: 4px solid var(--green);">
              <h3 style="color: var(--green); margin-top: 0;">Hazardous Weather Outlook</h3>
              <pre style="white-space: pre-wrap; font-family: inherit; font-size: 0.85rem; opacity: 0.8;">${hwoProduct.productText}</pre>
            </div>`;
        }

        if (!hazardFound) {
          hb.innerHTML = '<i class="fa-solid fa-shield-halved"></i> No Hazards';
          hb.classList.remove('active-warn');
          alertBody.innerText = "All clear.";
        }

        const afdList = await fetch(`https://api.weather.gov/products/types/AFD/locations/${officeId}`).then(r => r.json());
        const afd = await fetch(afdList['@graph'][0]['@id']).then(r => r.json());
        document.getElementById('bodyAFD').innerText = afd.productText;

        document.getElementById('ping').innerText = Date.now() - start;
        document.getElementById('syncStamp').innerText = new Date().toLocaleTimeString();
      } catch (e) {
        console.error(e);
      }
    }

    function getIcon(c) {
      if (c === 0) return "‚òÄÔ∏è";
      if (c < 4) return "‚õÖ";
      if (c < 51) return "üå´Ô∏è";
      if (c < 61) return "üåßÔ∏è";
      if (c < 80) return "‚ùÑÔ∏è";
      return "‚õàÔ∏è";
    }

    function openModal(id) {
      document.getElementById(id).style.display = 'block';
      if (audioOn) document.getElementById('sndClick').play();
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function toggleAudio() {
      audioOn = !audioOn;
      document.getElementById('volIcon').className = audioOn ? 'fa-solid fa-volume-high' : 'fa-solid fa-volume-xmark';
    }

    document.getElementById('zipInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') refreshStation(); });

    setInterval(() => {
      document.getElementById('systemClock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }, 1000);

    // 15-Minute Auto Refresh
    setInterval(refreshStation, 900000);

    // Keep Leaflet happy on resize/rotate
    window.addEventListener('resize', () => {
      if (map) map.invalidateSize(true);
    });

    // Init
    loadSavedState();
    loadBoostState();
    refreshStation();
  </script>
</body>
</html>
